{% extends "site.twig" %} 

{% set helpers = {
	'text': 'text only',
	'keyword': 'with key words',
	'sentence': 'with key sentences',
	'all': 'with all elements'
} %}


{% block title %}{{ task.name }} v{{ draft.version }} - Essay Overview ({{ helpers[mashup] }}){% endblock %} 
{% block subheader %}Your Draft : Overview ({{ helpers[mashup] }}){% endblock %} 


{% block bccontainer %}		
	{% include "widgets/breadcrumb.task.twig" %}
{% endblock %}

{% block navsubheader %}
	{% include "widgets/navbar.drafts.twig" with {'navsrc': 'me.draft.show'} %}
{% endblock %}

{% block content %}

<div class="row-fluid"><div class="span12">
	
	<div class="widget">
		<div class="widget-header">
			<h2>Your essay</h2>
		</div>
		<div class="widget-toolbar "><div class="btn-toolbar form-inline">    
			
			<div class="btn-group">
				<label style="margin-right: 5px;" class="checkbox">Show: </label>	
				<a class="btn btn-small {{ mashup=='text' ? 'active'}}" href="{{ urlFor('me.draft.show',{'draft':draft.id,'cmd':''}) }}">Text</a>
				<a class="btn btn-small {{ mashup=='keyword' ? 'active'}}" href="{{ urlFor('me.draft.showext',{'draft':draft.id,'cmd':'keyword'}) }}">Key Words</a>
				<a class="btn btn-small {{ mashup=='sentence' ? 'active'}}" href="{{ urlFor('me.draft.showext',{'draft':draft.id,'cmd':'sentence'}) }}">Key Sentences</a>
				<a class="btn btn-small {{ mashup=='all' ? 'active'}}" href="{{ urlFor('me.draft.showext',{'draft':draft.id,'cmd':'all'}) }}">All</a>
			</div>
			{% if mashup == 'all' %}
    		<div class="btn-group">
		    	<button data-target="#modal_mashup" role="button" class="btn btn-small " data-toggle="modal">
					More Options...</button>
			</div>
			{% endif  %}
        </div></div>
		
		
		
		<div class="widget-content assignment myessay openessay par-container" style="display: none;"><i class="icon-quote-left icon-4x pull-left icon-muted"></i>
			<p>{{ task.assignment | raw | nl2br }}</p>
		</div>
        
		<div class="widget-content widget-essay myessay openessay">
		{% for par in parasenttok %}
			
			<div class="par-wrapper" {{ (par.partag)?"data-tag=#{ par.partag }":"" }}>
				<div class="par-tag" {{ (par.partag)?"data-tag=#{ par.partag }":"" }}>
					<span class="icon-stack">
          			<i class="icon-circle-blank  icon-stack-base"></i>
          			<i class="icon-heading "></i>
        </span>
				</div>
				<div class="par-container">
					<p id="{{ loop.index0 }}" class='oe-par' >
			{% for sent in par %}
						<span class="oe-snt" data-index="{{ sent.id }}" data-tag="{{ sent.tag }}" {{ (sent.rank is defined)? "data-rank="~(sent.rank+1):"" }}>
						  {{ sent.text }}</span>
			{% endfor %}
					</p>
				</div>
			</div>
		{% endfor %}
		</div>        
        
		
	</div>

</div></div>


<div id="modal_mashup" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
	<div class="modal-header">
		<h1 id="modal-title">Display Options</h1>
	</div>
	<div class="modal-body">
	
	<p>Select the elements to show with the draft.</p>
	
	<form class="row-fluid" id="mashup-options">

	{% if not(config.structure.show is defined and config.structure.show == false) %}
	{% set cfg = config.structure %}
	{% set dsb = (cfg.modify is sameas(false))?"disabled" %}
	<div class="widget-content span3"><fieldset> 
		<legend>Structure</legend>
    	<label class="checkbox"> 
			<input  type="checkbox" name="structure" value="#-s:t#" class="cStructure" {{ ('#-s:t#' is inOption(cfg.check))? "checked=\"checked\""}} {{ dsb }}> 
			Title
		</label>
		<label class="checkbox"> 
			<input  type="checkbox" name="structure" value="#-s:h#" class="cStructure" {{ ('#-s:h#' is inOption(cfg.check))? "checked=\"checked\""}} {{ dsb }}>  
			Headings
		</label>
		<label class="checkbox"> 
			<input  type="checkbox" name="structure" value="#+s:i#" class="cStructure" {{ ('#+s:i#' is inOption(cfg.check))? "checked=\"checked\""}} {{ dsb }}>  
			Introduction
		</label>
		<label class="checkbox"> 
			<input  type="checkbox" name="structure" value="#+s#" class="cStructure" {{ ('#+s#' is inOption(cfg.check))? "checked=\"checked\""}} {{ dsb }}>  
			Body
		</label>
		<label class="checkbox"> 
			<input type="checkbox" name="structure" value="#+s:c#" class="cStructure" {{ ('#+s:c#' is inOption(cfg.check))? "checked=\"checked\""}} {{ dsb }}>  
			Conclusion
		</label>
		<label class="checkbox"> 
			<input type="checkbox" name="structure" value="#-s:q#;#-s:n#;#-s:p#" class="cStructure" {{ ('#-s:q#' is inOption(cfg.check))? "checked=\"checked\""}} {{ dsb }}>  
			Others
		</label>
									
	</fieldset></div>
	{% endif %}
	
	{% if not(config.sentence.show is defined and config.sentence.show == false) %}
	<div class="widget-content span3"> <fieldset>
		<legend> Sentences </legend>

		<label class="checkbox"> 
			<input  type="checkbox" name="sentence" value="show" class="cSentence" {{ dsb }}> 
			Show the key sentences
		</label>
		
		{#
		<div class="controls controls-row">
			<div class="control-group">
				<label class="">Top Sentences: <span id="amount" class="input unedidtable-input">0 - 0</span> </label>
				<div id="slider-range"></div>
				<span class="help-block">Set range of top sentences to display.</span> 
			</div>
		</div>
		#}
	</fieldset></div> 
	{% endif %}
	
	{% if not(config.keyword.show is defined and config.keyword.show == false) %}
	{% set cfg = config.keyword %}
	<div class="widget-content span3"><fieldset>
			<legend> Key Words </legend>
						
							
			{% for key,item in groups %}
			<div class="controls controls-row">	
				<label class="checkbox inline">
					<input type="checkbox" name="keywords" value="{{ item.id }}" class="cKeyword"
					{{ (item.id is inOption(cfg.check,false))? "checked=\"checked\""}}> {{ item.attr.name ? item.attr.name : "Default Group" }}
				</label>
			</div>	
			{% endfor %}
			{#<hr>
			<div class="controls controls-row">
					<a class="btn btn-small" rel="tooltip" title="Organise the keywords" 
						href="{{ urlFor('me.draft.act.keyword',{"draft":draft.id}) }}">
							<i class="icon-random"></i>
							Groups...
					</a>
			</div>#}
	</fieldset> </div>
	{% endif %}
	 
			
			<div class="widget-content span3"> <fieldset>
				<legend> Assignment </legend>

							<div class="controls controls-row">
								<div class="controls">
									<label class="checkbox inline"> 
										<input type="checkbox" value="show" 
											   name="task" class="cTaskQuestion" checked="checked"> Show the question
									</label>

								</div>
							
							</div>
			</fieldset></div> 
		</form> {# end of form #}
	</div>
	<div class="modal-footer">
	
		<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">OK</button>
	</div>
</div>

{% endblock %}



{% block injectCSS %}
{{ parent() }}
<link href="{{ app_base }}/assets/openessayist/css/hljs.css" rel="stylesheet">
<style type="text/css">


.btn-toolbar .title {
  display: block;
  float: left;
  margin-top: -4px; /* Recover part of margin set in child Header nodes */
  margin-left: 10px;
  font-size: 20px;
  font-weight: 200;
  color: #777777;
  text-shadow: 0 1px 0 #ffffff;
}

.icon-heading
{
	vertical-align: middle;
	color: black;
	font-family: sans-serif;Arial;
	font-weight: bolder;
}

p.oe-par {
	/*margin: 1em 0 1em 0;*/
	white-space: inherit;
	/*border-left: 10px solid #D5D5D5;*/
	/*margin-left: -5px;*/
    /*padding-left: 10px;*/
}

/*p.oe-par[data-tag='#+s:i#'] {
	border-left: 10px solid red;
}

p.oe-par[data-tag='#+s:c#'] {
	border-left: 10px solid green;
}

p.oe-par:before
{
	content: "";
}*/

.widget-essay
{
	/*display: table;*/
}

.par-wrapper
{	
	/*display: table-row;*/
	border-bottom: 2px solid white;
    border-top: 2px solid white;
}
.par-tag
{
    display: table-cell;
    width: 18px;
    background-color: #D5D5D5 !important;;
    border-right: 8px solid white;
        text-align: center;
    vertical-align: top;
    cursor: pointer;
    font-size: 11px;
    font-weight: bolder;
    min-width: 50px;
   
}

/*.par-tag[data-tag='#+s:c#']:after
{
	content:"Conclusion";
}*/

.par-tag[data-tag='#+s:i#'] {
	background-color: rgba( 246, 184, 184,0.25) !important;
	color: rgba(246, 184, 184,0.5) !important;;
}

.par-tag[data-tag='#-s:h#'] {
	background-color: rgba(202 ,178 ,214,0.25) !important;;
	color: rgba(202 ,178 ,214,0.5) !important;;
}

.par-tag[data-tag='#+s#'] {
	background-color: rgba(178 ,223 ,138,0.25) !important;;
	color: rgba(178 ,223 ,138,0.5) !important;;
}

.par-tag[data-tag='#+s:c#'] {
	background-color: rgba(31, 120 ,180 ,0.25) !important;;
	color: rgba(31, 120 ,180 ,0.5) !important;;
}

.par-tag[data-tag='#-s:q#'] {
	background-color: rgba(106, 61, 154  ,0.25) !important;;
	color: rgba(106, 61, 154  ,0.5) !important;;
}

.par-tag[data-tag='#-s:t#'] {
	background-color: rgba( 253, 191, 111 ,0.25) !important;;
	color: rgba(253, 191, 111  ,0.5) !important;;
}

.par-tag[data-tag='#+s#'] .icon-heading:before
{
	content:"D";
}
.par-tag[data-tag='#+s:c#'] .icon-heading:before
{
	content:"C";
}

.par-tag[data-tag='#-s:h#'] .icon-heading:before
{
	content:"H";
}

.par-tag[data-tag="#+s:i#"] .icon-heading:before
{
	content:"I";
}

.par-tag[data-tag="#-s:q#"] .icon-heading:before
{
	content:"Q";
}

.par-tag[data-tag="#-s:t#"] .icon-heading:before
{
	content:"T";
}

/*
.par-tag[data-tag='#-s:t#'] {
	background-color: #1F78B4 !important;;
}

.par-tag[data-tag='#-s:h#'] {
	background-color: #A6CEE3 !important;;
}

.par-tag[data-tag='#+s:i#'] {
	background-color: #FB8072 !important;;
}

.par-tag[data-tag='#+s:c#'] {
	background-color: #B3DE69 !important;;
}*/

.par-container
{
	display: table-cell;
}

span.oe-snt {
	white-space: normal;
	display: inline;
}

span.oe-snt[data-tag='#-s:t#']{
	font-weight: bold;
}
        			
span.oe-snt[data-tag='#-s:h#']{
	font-weight: bold;
}

span.oe-snt[data-rank].showmu:before {
	content:	attr(data-rank);
	background-color: #3A87AD;
	border-radius: 9px 9px 9px 9px;
	color: #FFFFFF;
	
	margin-right: 10px;
	padding-left: 9px;
	padding-right: 9px;
	text-shadow: none;
}

span.oe-snt[data-rank].showmu{
	background-color: #D3E3D3 !important;
}

.widget.assignment
{
	display: none;
}

.assignment p{
font-style: italic;
 text-align: justify;
 }

.widget-content legend
{    font-size: 12px;
    font-weight: 800;
    margin-bottom: 10px;
    line-height: 18px;
}

.widget-content.collapse.in
{
	padding: 10px;
}
.widget-content.collapse
{
	padding: 0px;
}

.widget-header[data-target]
{
	cursor: pointer;
}

label.checkbox:before
{
	content: "";
}


.ngram.showKW > .keyword
{
	cursor: pointer;
}

.ngram.showKW .keyword {
	text-shadow: none;
	font-weight: bold;
}

.ngram.showKW {
	border-style: dotted;
	border-width: 1px;
	padding-left: 10px;
	padding-right: 10px;
}

.ngram.category_all.showKW .keyword {
	color: #880000 !important;
}

{% for key,item in groups[1:] %}
.ngram.{{item.id}} .keyword {
}

.ngram.{{item.id}}.showKW {
	border-color: {{ item.attr.color }} !important;
}

.ngram.{{item.id}}.showKW .keyword {
	color: {{ item.attr.color }} !important;
}
{% endfor %}

.popover-content .legend-titlebar
{
	display:table-row;
}

.popover-content .par-tag
{
	cursor: default;
}

.popover-content .legend-title
{
	font-weight: bolder; 
	display: table-cell;
	width: 100%;
}

.popover-content .legend-content
{
	margin-top: 10px;
}

</style>
{% endblock %}

{% block injectJS %}
	{{ parent() }}
<script src="{{ app_base }}/assets/d3.js/colorbrewer.js"></script>
<script src="{{ app_base }}/assets/highlight.js/highlight.pack.js"></script>
	
<script id="tag-popover">
$(document).ready(function() {
	var sections = 
	{
		'????':		{title:'Unknown Tag', desc: 'There seems to be a problem.'},
		'#+s:c#': 	{title:'Conclusion', desc: 'This paragraph is part of the conclusion of your essay.'}, 
		'#+s:d_i#':	{title:'Discussion',desc: 'This paragraph is one of the discusssion parts of your essay.'}, 
		'#+s#':		{title:'Discussion',desc: 'This paragraph is one of the discusssion parts of your essay.'}, 
		'#+s:s#': 	{title:'Summary', desc: ''},
		'#+s:i#':	{title:'Introduction', desc: ''},
		'#-s:t#':	{title:'Title', desc: ''},
		'#+s:p#':	{title:'Preface', desc: ''},
		'#-s:h#':	{title:'Heading', desc: ''},
		'#-s:n#':	{title:'Numerics', desc: ''},
		'#-s:q#':	{title:'Assignment',  desc: ''},
		'#-s:p#':	{title:'Punctuation',desc: ''},				
	};	

	keys=[];
	for (v in sections) keys.push(v);
		
	var tag_tooltip = null;
	$(".par-wrapper .par-tag").popover({
		container: "body",
		placement: "right",
		html: true,
		template: '<div class="popover"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',
		trigger: "click hover", //"manual"
		content: function(){ 
			
			return 	"<div class='legend-titlebar'><div data-tag='"+$(this).attr('data-tag')+"' class='par-tag'>"+
					"<span class='icon-stack'>"+
  					"<i class='icon-circle-blank  icon-stack-base'></i>"+
  					"<i class='icon-heading '></i></span>"+
					"</div><div class='legend-title'>" + sections[$(this).attr('data-tag')].title + "</div></div>"+
					"<div class='legend-content'>"+ sections[$(this).attr('data-tag')].desc +"</div>";
		}
	});

	$(".par-tagXX").tooltip({
		title : function(){ 
				return sections[$(this).attr('data-tag')].title;
			},
			container: "body",
			placement: "right",
			
	});
		
});
</script>	

{% if mashup in ['keyword','all'] %}
	{% include "javascript/hljs.keywords.js.twig" %}

<script id="tag-keywords">
$(document).ready(function() {
	
	// initialise the code highlighting
	$('.par-container').each(function(i, e) {
		hljs.highlightBlock(e)
	});

	$('.cKeyword').change(function() {
		var cbox = this;
		var indicator = cbox.value;
		var classname = ".ngram."+indicator;
		console.log("Group activated :  " + indicator + " (" + cbox.checked + ")");
		if (cbox.checked)
			$(classname).addClass("showKW");
		else
			$(classname).removeClass("showKW");
	});

	$('.cKeyword').prop('checked', true);
	$('.cKeyword').trigger('change');
});
</script>
{% endif %}

{% if mashup in ['sentence','all'] %}
<script id="tag-sentences">
$(document).ready(function() {

	$('.cSentence').change(function() {
		var cbox = this;
		var indicator = cbox.value;
		var classname = "span.oe-snt[data-rank]";
		console.log("Sentence activated :  " + indicator + " (" + cbox.checked + ")");
		if (cbox.checked)
			$(classname).addClass("showmu");
		else
			$(classname).removeClass("showmu");
	});

	$('.cSentence').prop('checked', true);
	$('.cSentence').trigger('change');

	
	/*function highlighSentence(event, ui) {
		$("#amount").text(ui.values[0] + " - " + ui.values[1]);
		$('span.oe-snt[data-rank]').each(function() {
			var tt = parseInt($(this).attr('data-rank'));
			var mina = ui.values[0];
			var maxa = ui.values[1];
			
			$(this).removeClass('showmu');
			$(this).removeClass('dimshowmu');
			if (mina <= (tt) && (tt) <= maxa) {
				// if (tt == maxa)
				$(this).addClass('showmu');
				//console.log(mina + " " + maxa);
				
				//console.log("show" + tt);
				// else
				// $(this).addClass('dimshow');

			}
		})
	}*/	
	
		// set the sentence slider
		/*var smin = 0;
		var smax = {{ mashup=='all'? '0' : '15' }};
		$("#slider-range").slider({
			range : true,
			min : 0,
			max : 15,
			values : [ smin, smax ],
			slide : highlighSentence,
			change: function(event, ui) {
					console.log("Sentences Activated.");
					highlighSentence(event, ui);
				}
		});*/

		//$('#slider-range').slider("value", {'min':smin});
});
</script>
{% endif %}

{% if mashup in ['all'] %}
<script id="tag-all">
$(document).ready(function() {
	$('.cTaskQuestion').change(function() {
		var cbox = this;
		var classname = ".widget-content.assignment";
		if (cbox.checked)
			//$(classname).show("fast");
			$(classname).css({'display':'block'});
		else
			$(classname).css({'display':'none'});
	
	});


	
	$('.cStructure').change(function() {
		var cbox = this;
		var indicators = cbox.value.split(";");
		indicators.forEach(function(elt, idx, arr) {
			var classname = ".par-wrapper[data-tag='" + elt + "']";
			if (cbox.checked)
				//$(classname).show("fast");
				$(classname).css({'display':'block'});
			else
				$(classname).css({'display':'none'});
				//$(classname).hide("fast");
		});

	});
	
	$('.cTaskQuestion').trigger('change');
	$('.cStructure').trigger('change');
});
</script>
{% endif %}

<script id="mashup-init">
$(document).ready(function() {
	var h = $("form").serializeArray();
	openEssayist.log4j("{{ constant('TutorController::ACTION_MASHUP_INIT') }}",h);

    $('#modal_mashup').on('hide', function ()
	{
    	openEssayist.log4j("{{ constant('TutorController::ACTION_MASHUP_SELECT') }}",h);
		console.log("clode");    
	});
	
});

</script>
{% endblock %}
